var LeaptAdmin={};LeaptAdmin.Ui=function(){var e=LeaptBootstrap.Modal.extend({initialize:function(){LeaptBootstrap.Modal.prototype.initialize.apply(this,arguments),this.off("ui:modal:render"),this.on("ui:modal:render",_.partial(LeaptAdmin.Form.factories.collectionFactory,this.$el)),this.on("ui:modal:render",_.partial(LeaptAdmin.Form.factories.textAutocompleteFactory,this.$el)),this.on("ui:modal:render",_.partial(LeaptAdmin.Form.factories.autocompleteFactory,this.$el)),this.on("ui:modal:render",this.checkAlerts),this.on("ui:modal:success",this.success)},success:function(e){$("[data-admin=ui-alerts]").admin_ui_alerts("addMessages",e.flashes,!0)},checkAlerts:function(e){this.$("[data-admin=ui-alerts]").admin_ui_alerts()}}),t=function(){var e=0===arguments.length?$("body"):arguments[0];e.on("click","[data-admin=content-modal]",function(e){e.preventDefault();var t=$(e.currentTarget),i={url:t.attr("href")};t.data("options-modal-class")&&(i.modalClass=t.data("options-modal-class")),i.backdrop=t.data("options-modal-backdrop"),new LeaptAdmin.Ui.Modal(i)})},i=Backbone.View.extend({events:{"click [data-dismiss=alert]":"removeMessage"},initialize:function(){this.$el.find(".alert").each(_.bind(function(e,t){this.scheduleForRemoval($(t))},this))},addMessages:function(e,t){"undefined"==typeof t&&(t=!1),t&&this.clear(),_.each(e,_.bind(function(e,t){_.each(e,_.bind(function(e){this.addMessage(t,e)},this))},this))},addMessage:function(e,t){var i=$('<div class="alert alert-'+e+'">');i.append($('<a href="#" class="close" data-dismiss="alert">&times;</a> ')),i.append(t),this.$el.append(i),this.scheduleForRemoval(i)},scheduleForRemoval:function(e){setTimeout(function(){e.slideUp(e.remove)},5e3)},removeMessage:function(e){e.preventDefault();var t=$(e.currentTarget).parents(".alert");t.slideUp(t.remove)},clear:function(){this.$el.html("")}});return $.fn.admin_ui_alerts=function(){var e,t;return arguments.length>0&&(e=arguments[0],t=_.toArray(arguments).slice(1)),this.each(function(){var a=$(this),n=a.data("leapt_admin_ui_alerts");n||a.data("leapt_admin_ui_alerts",n=new i({el:a})),"undefined"!=typeof e&&n[e].apply(n,t)})},{Modal:e,modalFactory:t}}(),function(e){LeaptAdmin.Ui.modalFactory(),e("[data-admin=ui-alerts]").admin_ui_alerts()}(jQuery),LeaptAdmin.Form=function(e){var t=LeaptCore.Form.Collection.extend({events:{"click .add-element":"addItem","click *[data-admin=form-collection-add]":"addItem","click .remove-element":"removeItem","click [data-admin=form-collection-remove]":"removeItem"},initialize:function(e){this.options=e||{},LeaptCore.Form.Collection.prototype.initialize.apply(this)},removeItem:function(t){t.preventDefault();var i,a=e(t.currentTarget);if(i=a.parents("[data-admin=form-collection-item]"),0===i.length&&(i=a.parent()),this.options.confirmDelete){var n=new LeaptBootstrap.Modal({url:this.options.confirmDeleteUrl});n.on("modal:confirm",_.bind(function(){this.fadeAndRemoveItem(i)},this))}else this.fadeAndRemoveItem(i)},fadeAndRemoveItem:function(e){e.fadeOut(_.bind(function(){e.remove(),this.trigger("form:collection:remove"),this.$form.trigger("change")},this))}}),i=function(){var i=arguments[0]||"body";e("[data-admin=form-collection]",i).each(function(i,a){e(a).data("widget")||e(a).data("widget",new t({el:a,confirmDelete:!!e(a).data("options-confirm-delete-url"),confirmDeleteUrl:e(a).data("options-confirm-delete-url")?e(a).data("options-confirm-delete-url"):null}))})},a=Backbone.View.extend({$textInput:null,listUrl:null,$typeahead:null,initialize:function(){this.$el.css("position","relative"),this.$textInput=this.$el.find("input[type=text]"),this.listUrl=this.$el.data("options-url"),this.initializeTypeahead()},initializeTypeahead:function(){var e=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:this.listUrl,wildcard:"__query__"}});this.$typeahead=this.$textInput.typeahead({minLength:3,items:10,highlight:!0},{display:"value",source:e})}}),n=function(){var t=arguments[0]||"body";e("[data-admin=form-text-autocomplete]",t).each(function(t,i){e(i).data("widget")||e(i).data("widget",new a({el:i}))})},l=a.extend({mode:null,events:{"click a[data-admin=content-add]":"add","click a[data-admin=form-autocomplete-clear]":"clear","typeahead:select input[type=text]":"updater"},initialize:function(){a.prototype.initialize.apply(this),this.$valueInput=this.$el.find("input[type=hidden]"),this.mode=this.$el.data("options-mode"),this.$close=null,"multiple"===this.mode?e("ul.tokens").on("click","a[rel=remove]",_.bind(function(t){t.preventDefault();var i=e(t.currentTarget),a=i.parent("li").data("value");i.parent("li").remove(),this.$el.find("input[value="+a+"]").remove()},this)):!this.$valueInput.val()||this.$textInput.attr("disabled")||this.$textInput.attr("readonly")||this.appendClearButton()},appendClearButton:function(){null===this.$close&&(this.$close=e('<a href="#" data-admin="form-autocomplete-clear" class="close">&times;</button>'),this.$textInput.after(this.$close))},invalidate:function(){"single"===this.mode&&this.$el.find("input[type=hidden]").val("").trigger("change"),this.$el.closest(".control-group").addClass("warning")},updater:function(t,i){if("single"===this.mode)this.$el.find("input[type=hidden]").val(i.id).trigger("change"),this.$el.parents(".control-group").removeClass("warning"),this.appendClearButton();else{var a=e.trim(this.$el.data("prototype")),n=e(a.replace(/__name__/g,this.$el.find("input[type=hidden]").length));n.val(i.id),this.$el.append(n);var l=e("<li>").addClass("token").data("value",i.id).html(e("<span>").html(i.value)).append(e("<a>").html("&times;").addClass("close").attr("rel","remove"));this.$el.find(".tokens").append(l),n.trigger("change"),this.$el.parents(".control-group").removeClass("warning"),this.$typeahead.typeahead("val","")}},add:function(t){t.preventDefault();var i=e(t.currentTarget),a=new LeaptAdmin.Ui.Modal({url:i.attr("href")});a.on("ui:modal:success",_.bind(function(t){var i=(e("<option>"),t.result.entity_id),a=t.result.entity_name;if("single"===this.mode)this.$textInput.val(a),this.$valueInput.val(i).trigger("change");else{var n=e.trim(this.$el.data("prototype")),l=e(n.replace(/__name__/g,this.$el.find("input[type=hidden]").length));l.val(i),this.$el.prepend(l),l.trigger("change");var o=e("<li>").addClass("token").html(e("<span>").html(a)).append(e("<a>").html("&times;").addClass("close").attr("rel","remove"));this.$el.find(".tokens").append(o)}},this))},clear:function(e){e.preventDefault(),this.$textInput.val(""),this.invalidate(),"single"===this.mode&&(this.$close.remove(),this.$close=null)}}),o=function(){var t=arguments[0]||"body";e("[data-admin=form-autocomplete]",t).each(function(t,i){e(i).data("widget")||e(i).data("widget",new l({el:i}))})},s=Backbone.View.extend({events:{"click .multiupload-file-preview .remove":"removeFile"},initialize:function(){this.entryTemplate=this.$el.attr("data-prototype"),this.$uploader=this.$(".multiupload-file-uploader"),this.$uploaderForm=this.$uploader.find("input"),this.$progress=this.$uploader.find(".progress"),this.$progressLoaded=this.$uploader.find(".progress-bar-loaded"),this.$el.data("index",this.$el.find(".multiupload-file-preview").length),this.$uploaderForm.fileupload({start:_.bind(this.start,this),done:_.bind(this.done,this),progressall:_.bind(this.progressall,this),fail:_.bind(this.fail,this),dataType:"json",limitConcurrentUploads:3,progressInterval:40})},start:function(){this.$progress.css("display","block")},progressall:function(e,t){this.$progress.find(".bar").width(parseInt(t.loaded/t.total*100,10)+"%")},done:function(t,i){this.$progress.hide(),this.$uploaderForm=this.$uploader.find("input");var a=this.$el.data("index"),n=e(this.entryTemplate.replace(/__name__/g,a)),l=i.result.url;switch(n.find("input[type=hidden]").val(l),$link=n.find("a"),$link.attr("href",function(){return l}),this.$el.data("type")){case"Leapt\\AdminBundle\\Form\\Type\\MultiUploadUrlType":$link.text(l);break;case"Leapt\\AdminBundle\\Form\\Type\\MultiUploadImageType":n.find("img").attr("src",function(){var e=this.src.split("?");return e[0]+l+(e[1]?"?"+e[1]:"")})}this.$el.data("index",a+1),this.$uploader.before(n)},fail:function(e,t){console.log("error while uploading")},removeFile:function(t){t.preventDefault(),e(t.currentTarget).parents(".multiupload-file-preview").remove()}}),r=function(){var t=arguments[0]||"body";e("[data-multi-upload]",t).each(function(t,i){e(i).data("widget")||e(i).data("widget",new s({el:i}))})},d=Backbone.View.extend({initialize:function(){this.locked=!0,this.$target="",this.currentSlug="",this.$modal=e(this.$el.data("modal")),this.$modal.modal({show:!1});var t=this.$el.attr("id").split("_");if(t.pop(),this.$target=e("#"+t.join("_")+"_"+this.$el.data("target")),0===this.$target.length)throw"wrong target specified for slug widget ("+this.$el.data("target")+")";this.$el.attr("readonly","readonly"),""===this.$el.val()?(this.$el.val(this.makeSlug(this.$target.val())),this.listenTarget()):this.currentSlug=this.$el.val(),this.appendLockButton()},appendLockButton:function(){this.$modal.find("a[data-accept=modal]").on("click",_.bind(function(){this.unlock(),this.$modal.modal("hide")},this)),this.lockButton=this.$el.parent().find("a"),this.lockButton.on("click",_.bind(function(e){e.preventDefault(),this.locked?this.$modal.modal("show"):this.lock()},this))},unlock:function(){this.locked=!1,this.lockButton.find("i").toggleClass("fa-pencil fa-magnet"),this.$el.removeAttr("readonly")},lock:function(){this.locked=!0,this.lockButton.find("i").toggleClass("fa-pencil fa-magnet"),""!==this.currentSlug?this.$el.val(this.currentSlug):this.$el.val(this.makeSlug(this.$target.val())),this.$el.attr("readonly","readonly")},makeSlug:function(e){var t=e.toLowerCase().replace(/^\s+|\s+$/g,"").replace(/\s+/g,"-");return t.replace(/[àâä]/g,"a").replace(/[éèêë]/g,"e").replace(/[îï]/g,"i").replace(/[ôö]/g,"o").replace(/[ûüù]/g,"u").replace(/[ýÿ]/g,"y").replace(/[ç]/g,"c").replace(/[œ]/g,"oe").replace(/[^a-zA-Z0-9\-]/g,"").replace(/^\-+|\-+$/,"")},listenTarget:function(){this.$target.keyup(_.bind(function(){"readonly"===this.$el.attr("readonly")&&this.$el.val(this.makeSlug(this.$target.val()))},this))}}),c=function(){var t=arguments[0]||"body";e(".widget-slug, [data-admin=form-slugger]",t).each(function(t,i){e(i).data("widget")||e(i).data("widget",new d({el:i}))})},h=Backbone.View.extend({events:{"click a[data-admin=form-type-entity-add]":"onEntityAddClick"},initialize:function(){this.$select=this.$el.find("select")},onEntityAddClick:function(e){e.preventDefault();var t=new LeaptAdmin.Ui.Modal({url:e.currentTarget.href});t.on("ui:modal:success",this.onModalSuccess,this)},onModalSuccess:function(t){var i=t.result.entity_id;this.$select.append(e("<option>").html(t.result.entity_name).val(i)).val(i)}}),u=function(){var t=arguments[0]||"body";e("[data-admin=form-type-entity]",t).each(function(t,i){e(i).data("widget")||e(i).data("widget",new h({el:i}))})},p=Backbone.View.extend({initialize:function(){p.instanceCount++;var t=this.$el.children(":not(legend)").detach();this.$legend=this.$el.children("legend").addClass("no-border"),this.$icon=e("<span></span>").addClass("icon icon-chevron-up"),this.$legend.append(this.$icon),this.$collapsibleContent=e("<div></div>").addClass("well well-light collapsible-content").append(t),this.$el.append(this.$collapsibleContent),this.$legend.on("click",_.bind(this.toggle,this)),this.isOpen=!0},toggle:function(){this.$legend.toggleClass("no-border"),this.$icon.toggleClass("icon-chevron-down icon-chevron-up"),this.$collapsibleContent.slideToggle(),this.isOpen=!this.isOpen;var e=this.isOpen?"open":"close";this.trigger("form:collapsible:"+e),this.$el.trigger("form:collapsible:"+e)},close:function(){this.$legend.removeClass("no-border"),this.$icon.addClass("icon-chevron-down").removeClass("icon-chevron-up"),this.$collapsibleContent.slideUp(),this.isOpen=!1,this.trigger("form:collapsible:close"),this.$el.trigger("form:collapsible:close")}},{instanceCount:0}),m=function(){var t=arguments[0]||"body",i=e("fieldset.collapsible, [data-admin=form-collapsible-fieldset]",t);i.length>p.instanceCount&&i.each(function(t,i){var a=e(i).data("widget");a||e(i).data("widget",a=new p({el:i})),(t>0||a.$el.hasClass("metas"))&&0===a.$(".error").length&&a.close()})},f=Backbone.View.extend({initialize:function(){CKEDITOR.replace(this.el,{customConfig:this.$el.data("wysiwyg")}),this.editor=CKEDITOR.instances[this.$el.attr("id")],this.editor.on("blur",_.bind(function(){!0===this.editor.checkDirty()&&this.$el.parents("form").trigger("change")},this))}}),g=function(){var t=arguments[0]||"body";e(".widget-wysiwyg, [data-admin=form-wysiwyg-editor]",t).each(function(t,i){e(i).data("widget")||e(i).data("widget",new f({el:i}))})},$=LeaptCore.Form.Manager.extend({initialize:function(){LeaptCore.Form.Manager.prototype.initialize.apply(this),autosize(this.$(".catalogue-translation textarea")),this.addErrorClasses(),e('a:not([href^="#"])').not("[data-admin]").on("click",_.bind(this.onExternalLinkClick,this))},addErrorClasses:function(){this.$("fieldset").has(".error").each(function(){e("legend",e(this)).first().addClass("error")}),this.$(".tab-pane").has(".error").each(function(){e("a[href=#"+e(this).attr("id")+"]").parent().addClass("error")})},onExternalLinkClick:function(t){if(!t.ctrlKey&&!t.metaKey&&this.hasChanged){t.preventDefault();var i=e("#modal");e.get(LEAPT_ADMIN_CONTENT_CHANGE_URL,function(a){i.html(a),i.find(".cancel").click(function(){i.html(""),i.modal("hide")}),i.find(".proceed").click(function(){window.location.href=e(t.currentTarget).attr("href")}),i.find(".save").click(function(){e("[data-admin=form-change-warning]").submit()}),i.modal("show")})}}});return{Manager:$,Collection:t,TextAutocomplete:a,Autocomplete:l,Multiupload:s,Slugger:d,EntityWidget:h,CollapsibleFieldset:p,WysiwygEditor:f,factories:{collectionFactory:i,textAutocompleteFactory:n,autocompleteFactory:o,multiuploadFactory:r,sluggerFactory:c,entityWidgetFactory:u,collapsibleFieldsetFactory:m,wysiwygEditorFactory:g},instances:{managers:[]}}}(jQuery),jQuery(document).ready(function(){$("[data-admin=form-manager]").each(function(e,t){if(!$(t).data("widget")){var i=new LeaptAdmin.Form.Manager({el:t});_.each(LeaptAdmin.Form.factories,function(e){i.registerFactory(e)}),LeaptAdmin.Form.instances.managers.push(i),$(t).data("widget",i)}})});